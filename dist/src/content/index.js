var N=Object.defineProperty;var _=(m,u,y)=>u in m?N(m,u,{enumerable:!0,configurable:!0,writable:!0,value:y}):m[u]=y;var l=(m,u,y)=>_(m,typeof u!="symbol"?u+"":u,y);(function(){"use strict";const m=`⠡⠡⠡⠡⠡⣡⣥⡡⠡⠡⠡⠡⢡⣡⡥⠡⡑⡑⢕⢕
⠪⠨⠨⡈⠢⣹⣗⣍⣾⢿⢿⢷⣫⣻⡇⢕⢌⠪⡢⡱
⡑⠅⠕⠌⠬⢞⣔⠇⠅⢸⢸⢸⢸⡺⡯⡢⡑⡕⡜⡜
⡌⡊⡊⡊⣺⣿⢸⠨⡪⡪⡪⡪⡢⡹⣽⡎⡎⡎⡎⡎
⡪⡪⡪⡪⣺⣿⢸⢸⢸⢸⢸⢸⢸⢸⣽⡇⡇⡇⡇⡇
⢎⠪⡪⡪⡪⡺⡯⣮⡪⡪⡊⡊⣤⢷⡇⡇⡇⡇⡇⡇
⢣⢣⢪⢪⢪⢪⢹⠱⠿⠿⡻⣽⠫⣣⢣⢣⢣⢣⢣⢣
⡆⡣⡣⡣⡣⡣⡣⢍⢎⢇⢇⢇⣿⡿⣧⡇⡇⡇⡇⡇
⢱⢱⢱⢱⢱⢱⢱⢱⢱⢱⢱⢱⢱⣟⣗⣿⢸⢸⢸⢸
⢪⢪⢪⢪⢪⢪⢪⢪⢪⢪⢪⢪⢪⢺⢹⢱⢱⢱⢱⢱`;class u{constructor(e,t=!1){l(this,"pressed",!1);l(this,"subs",[]);l(this,"handleKeydown",e=>{e.key===this.keyName&&(this.pressed=!0,this==null||this.notify())});l(this,"handleKeyup",e=>{e.key===this.keyName&&(this.pressed=!1,this==null||this.notify())});l(this,"handleBlur",()=>{this.pressed=!1,this==null||this.notify()});this.keyName=e,this.once=t,this.setListeners()}subscribe(e){this.subs.push(e)}notify(){this.subs.forEach(e=>e(this.pressed)),this.once&&(this.subs=[],this.destroyListeners())}setListeners(){window.addEventListener("keydown",this.handleKeydown,{passive:!0}),window.addEventListener("keyup",this.handleKeyup,{passive:!0}),window.addEventListener("blur",this.handleBlur)}destroyListeners(){window.removeEventListener("keydown",this.handleKeydown),window.removeEventListener("keyup",this.handleKeyup),window.removeEventListener("blur",this.handleBlur)}}function y(s,e){const t=s.getBoundingClientRect(),n=Math.round((e.clientX-t.left)/(t.right-t.left)*100),r=Math.round((e.clientY-t.top)/(t.bottom-t.top)*100);return{x:n,y:r}}class w{constructor(){l(this,"state");const e=t=>{this.state=t};window.addEventListener("mousemove",e,{passive:!0}),window.addEventListener("contextmenu",e,{passive:!0})}}class M{constructor(e="Shift"){l(this,"scrollFactor",1);l(this,"subscriptions",[]);l(this,"controlKey");l(this,"handleScroll",e=>{this.controlKey.pressed&&(e.preventDefault(),this.scrollFactor=e.deltaY<0?1:-1,this.notify())});this.controlKeyName=e,this.controlKey=new u(this.controlKeyName),window.addEventListener("wheel",this.handleScroll,{passive:!1})}combineWithControlKey(e,t,n){new u(e).subscribe(r=>r&&new u(t,!0).subscribe(()=>n()))}setControlKey(e){this.controlKey=new u(e)}subscribe(e){this.subscriptions.push(e)}notify(){this.subscriptions.forEach(e=>{e(this.scrollFactor)})}}function E(s,e=2){g(s,n=>n.clientHeight>0&&n.clientWidth>0?(n.style.overflow="hidden",!0):!1,e)}function g(s,e,t=10){let n=t,r=s.parentElement;for(;n>0&&r&&!e(r);)r=r.parentElement,n--}function x(s,e){const t=document.createElement("a");t.download=e,t.href=s,t.click()}function b(s,e=.1){const t=window.getComputedStyle(s),n=Number.parseFloat(t.getPropertyValue("opacity")),r=t.getPropertyValue("display"),o=t.getPropertyValue("visibility");return n>e&&r!=="none"&&o!=="hidden"}function k(s){let{x:e,y:t,width:n,height:r}=s.getBoundingClientRect();return e=Math.max(e,0)|0,t=Math.max(t,0)|0,n=Math.min(n,window.innerWidth)|0,r=Math.min(r,window.innerHeight)|0,new DOMRect(e,t,n,r)}function O(s){return(s==null?void 0:s.title)||(s==null?void 0:s.alt)||document.title||""}class P{constructor(){l(this,"opacityThreshold",.1);l(this,"hoveredMedia_");l(this,"mouse",new w);l(this,"findHoveredMedia",()=>{if(this.hoveredMedia_&&b(this.hoveredMedia_,this.opacityThreshold)){const{x:n,y:r}=y(this.hoveredMedia_,this.mouse.state);if(n>0&&n<100&&r>0&&r<100)return{x:n,y:r,mediaElement:this.hoveredMedia_}}const t=(()=>{const n=[],r=Array.from(document.querySelectorAll("video,img,div")).reverse();for(const o of r){if(o.tagName==="DIV"&&!this.hasBackgroundImage(o)||!b(o,this.opacityThreshold))continue;const{x:a,y:c}=y(o,this.mouse.state);a>0&&a<100&&c>0&&c<100&&n.push({x:a,y:c,mediaElement:o})}if(n.length===1)return n[0];if(n.length>1)return this.findTopmost(n)})();return this.hoveredMedia_=t==null?void 0:t.mediaElement,t});this.watchHoveredMedia()}findTopmost(e){let t=0,n=0;const r=o=>{const a=window.getComputedStyle(o),c=a.getPropertyValue("position")==="absolute"?.5:0;return Number.parseInt(a.getPropertyValue("z-index"))||c};return e.forEach((o,a)=>{let c=r(o.mediaElement);g(o.mediaElement,h=>c>0?!0:(c=r(h),!1),15),c>n&&(n=c,t=a)}),e[t]}watchHoveredMedia(){document.addEventListener("mouseover",e=>{var t,n;e.target instanceof HTMLElement&&(((t=e.target)==null?void 0:t.tagName)==="IMG"||((n=e.target)==null?void 0:n.tagName)==="VIDEO"||this.hasBackgroundImage(e.target))&&(this.hoveredMedia_=e.target)}),document.addEventListener("mouseout",e=>{e.target===this.hoveredMedia_&&(this.hoveredMedia_=void 0)})}hasBackgroundImage(e){return e.style.backgroundImage.includes("url")}}function v(s,e,t){return Math.max(e,Math.min(s,t))}function S(){const{origin:s}=window.location;return browser.storage.sync.get([s]).then(e=>Object.hasOwn(e,s))}async function L(){await S()&&e();function e(){document.body.oncontextmenu=null,t(document)}function t(r){(r||document).addEventListener("contextmenu",n,!0)}function n(r){r.preventDefault(),r.stopPropagation()}}class V{constructor(e=.2,t="zoom-ext"){this.ZOOM_STEP=e,this.attrname=t}handleCommand(e,t){switch(e){case"mirror":this.mirror(t);break;case"invert":this.invert(t);break;case"rotate-right":this.rotate(t,90);break;case"rotate-left":this.rotate(t,-90);break;case"brightness-inc":this.brightness(t,25);break;case"brightness-dec":this.brightness(t,-25);break;case"zoom-inc":this.zoom(50,50,3,t);break;case"zoom-dec":this.zoom(50,50,-3,t);break}}resetAllMedia(){document.querySelectorAll(`[${this.attrname}]`).forEach(e=>{e.style.transform=""})}handleElement(e){e.hasAttribute(this.attrname)||(E(e,2),e.setAttribute(this.attrname,""),e.style.transition=".25s ease")}setOrReplaceStyleProp(e,t,n,r){var f;this.handleElement(e);const o=e.style,a=new RegExp(`${n}\\(([-|\\d+|\\.|deg|\\%]+)\\)`),c=(f=o.getPropertyValue(t).match(a))==null?void 0:f[1],h=r(c);let i="";c!==void 0?i=o.getPropertyValue(t).replace(a,()=>h):i=`${o.getPropertyValue(t)} ${h}`,o.setProperty(t,i)}brightness(e,t){this.setOrReplaceStyleProp(e,"filter","brightness",n=>`brightness(${Number.parseFloat(n||"100")+t}%)`)}invert(e){this.setOrReplaceStyleProp(e,"filter","invert",t=>`invert(${Number.parseFloat(t||"0")>0?0:100}%)`)}rotate(e,t){this.setOrReplaceStyleProp(e,"transform","rotate",n=>`rotate(${Number.parseFloat(n||"0")+t}deg)`)}mirror(e){this.setOrReplaceStyleProp(e,"transform","rotateY",t=>`rotateY(${180*(Number.parseFloat(t||"0")>0?0:1)}deg)`)}setTransformOrigin(e,t,n){var h;let r=e,o=t;const a=/rotateY.180/.test(n.style.transform);let c=Number.parseInt((h=n.style.transform.match(/rotate.(\d+)/))==null?void 0:h[1])||0;c=c<0?360-c%360:c%360,a||c?(c===90&&(r=t,o=100-e),c===270&&(r=100-t,o=e),c===180&&(r=100-e,o=100-t),a&&(r=100-e),r=v(r,15,85),o=v(o,15,85),this.ZOOM_STEP=.033):this.ZOOM_STEP=.2,n.style.transformOrigin=`${r}% ${o}%`}zoom(e,t,n,r){this.setTransformOrigin(e,t,r),this.setOrReplaceStyleProp(r,"transform","scale",o=>{const a=Number.parseFloat(o||"1");return`scale(${Math.max(1,a+this.ZOOM_STEP*n)})`})}}function C(s){const e=()=>{const i=document.createElement("div");return i.style.position="absolute",i.style.zIndex="9999999",i.style.left="0",i.style.top="0",i.style.width="100%",i.style.height="100vh",i.style.overflow="hidden",i.style.margin="0px",i.style.backdropFilter="blur(50px)",i},t=()=>{const i=document.createElement("div");return i.style.position="realtive",i.style.width="100%",i.style.height="100%",i.style.display="flex",i.style.overflow="hidden",i.style.margin="0px",i},n=i=>{const f={width:"auto",height:"auto","max-height":"100vh","max-width":"100vw",margin:"auto"},p={};return Object.keys(f).forEach(d=>{p[d]=i.style.getPropertyValue(d),i.style.setProperty(d,f[d])}),{restoreElement:()=>{Object.keys(f).forEach(d=>{p[d]?i.style.setProperty(d,p[d]):i.style.removeProperty(d)})}}},r=e(),o=t();document.body.append(r),r.append(o);let a=()=>{};if(s.nextElementSibling){const i=s.nextElementSibling;a=()=>i.before(s)}else if(s.previousElementSibling){const i=s.previousElementSibling;a=()=>i.after(s)}else{const i=s.parentElement;a=()=>i==null?void 0:i.append(s)}o.append(s);const{restoreElement:c}=n(s);return{removeOverflow:()=>{c(),a(),r.remove()}}}const K="Shift";function T(s){function e(){browser.storage.local.get(["controlKey"]).then(t=>{s.setControlKey((t==null?void 0:t.controlKey)||K)})}e(),browser.storage.onChanged.addListener(()=>e())}function R(){L();const s=new V,e=new P,t=new M;let n,r;browser.runtime.onMessage.addListener(o=>{if(console.log("content",o),o.transform||o.screenshot||o.search){const{mediaElement:a}=e.findHoveredMedia();r=a}if(console.log({mediaElement_:r}),o.search&&r){const a=r==null?void 0:r.getAttribute("src");if(!a)return;browser.runtime.sendMessage({searchImageGoogle:!0,src:a})}if(o.screenshot_ok&&(x(o.uri,`${O(r)}.png`),n==null||n()),o.screenshot&&r){const{removeOverflow:a}=C(r);n=a;const{x:c,y:h,height:i,width:f}=k(r);browser.runtime.sendMessage({captureRect:!0,rect:{x:c,y:h,height:i,width:f}})}o.reset&&s.resetAllMedia(),o.transform&&s.handleCommand(o.transform,r)}),T(t),t.subscribe(o=>{const{x:a,y:c,mediaElement:h}=e.findHoveredMedia();h&&s.zoom(a,c,o,h)})}R(),console.log(m)})();
